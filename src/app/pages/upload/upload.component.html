<div class="max-h-[78vh] overflow-y-auto">
  <nz-card class="max-h-[90vh] overflow-y-auto p-6 rounded-lg shadow-md bg-white">
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
      <div class="lg:col-span-2">
        <ng-container *ngIf="fileList.length; else uploadPlaceholder">
          <ng-container *ngIf="isImageFile(fileList[0].name); else checkPdf">
            <div class="w-full aspect-square bg-gray-100 border rounded-lg overflow-hidden shadow flex items-center justify-center">
              <img
                [src]="fileList[0].url || ''"
                alt="Preview Image"
                class="object-contain h-full w-full"
              />
            </div>
          </ng-container>
  
          <p class="mt-2 text-gray-600 text-sm italic text-center">
            {{ fileList[0].name }}
          </p>
          
          <button
            type="button"
            nz-button
            nzType="default"
            nzDanger
            [disabled]="isPreviewLoading"
            (click)="onDelete(fileList[0]['uid'])"
            class="mt-3 w-full"
          >
            <ng-container *ngIf="!isPreviewLoading; else loadingIcon">
              <i nz-icon nzType="delete" class="mr-1"></i>
              Delete File
            </ng-container>
          </button>
        </ng-container>
  
      </div>
      <form
        [formGroup]="form"
        (ngSubmit)="onSubmit()"
        nz-form
        nzLayout="vertical"
        class="lg:col-span-3"
      >
        <!-- Visibility -->
        <nz-form-item>
          <nz-form-label [nzRequired]="true">Visibility</nz-form-label>
          <nz-form-control>
            <nz-select formControlName="visibility" nzPlaceHolder="Select visibility">
              <nz-option
                *ngFor="let opt of visibilityOptions"
                [nzValue]="opt.value"
                [nzLabel]="opt.label"
              ></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
  
        <!-- Password Protected -->
        <nz-form-item *ngIf="form.value.visibility === 'password_protected'">
          <nz-form-label>Password</nz-form-label>
          <nz-form-control>
            <nz-input-group [nzSuffix]="suffixTemplate">
              <input
                [type]="passwordVisible ? 'text' : 'password'"
                nz-input
                formControlName="password"
                placeholder="Enter password"
              />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
  
        <!-- Expiration -->
        <nz-form-item>
          <nz-form-label>Expires At</nz-form-label>
          <nz-form-control>
            <input nz-input type="date" formControlName="expiresAt" />
          </nz-form-control>
        </nz-form-item>
  
        <!-- Max Download -->
        <nz-form-item>
          <nz-form-label>Max Download</nz-form-label>
          <nz-form-control>
            <input
              nz-input
              type="number"
              formControlName="downloadLimit"
              placeholder="e.g., 5"
            />
          </nz-form-control>
        </nz-form-item>
  
        <!-- Submit -->
        <nz-form-item>
          <nz-form-control>
            <button
              nz-button
              nzType="primary"
              class="w-full"
              [disabled]="form.invalid || isLoading || !fileList.length"
            >
              {{ isLoading ? 'Uploading...' : 'Save Metadata' }}
            </button>
          </nz-form-control>
        </nz-form-item>
      </form>
    </div>
  </nz-card>
</div>

<ng-template #uploadPlaceholder>
  <nz-form-item>
    <nz-form-control>
      <nz-upload
        nzType="drag"
        [nzBeforeUpload]="beforeUpload"
        [nzShowUploadList]="false"
        [(nzFileList)]="fileList"
        class="w-full"
      >
        <p class="ant-upload-drag-icon">
          <nz-icon nzType="inbox"></nz-icon>
        </p>
        <div *ngIf="!isPreviewLoading; else loadingIcon">
          <p class="ant-upload-text">Click or drag file here to upload</p>
          <p class="ant-upload-hint">PDF or Image</p>
        </div>
        
      </nz-upload>
    </nz-form-control>
  </nz-form-item>
</ng-template>

<ng-template #checkPdf>
  <ng-container *ngIf="isPDFFile(fileList[0].name);">
    <div class="w-full aspect-square bg-gray-100 border rounded-lg overflow-hidden shadow flex items-center justify-center">
      <iframe
        [src]="pdfPreviewUrl"
        class="w-full h-full border-0"
        role="document"
      ></iframe>
    </div>
  </ng-container>
</ng-template>

<ng-template #suffixTemplate>
  <nz-icon
    class="ant-input-password-icon cursor-pointer"
    [nzType]="passwordVisible ? 'eye-invisible' : 'eye'"
    (click)="passwordVisible = !passwordVisible"
  />
</ng-template>

<ng-template #loadingIcon>
  <i nz-icon nzType="loading" nzTheme="outline" nzSpin></i>
</ng-template>